name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  IMAGE_NAME: scalabit-api:latest

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.22"
      - run: go mod tidy
      - run: go test ./tests/... -v

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.22"
      - uses: golangci/golangci-lint-action@v6
      - run: golangci-lint run ./...

  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.22"
      - run: go install github.com/securego/gosec/v2/cmd/gosec@latest
      - run: gosec ./...

  build:
    runs-on: ubuntu-latest
    needs: [test, lint, security]
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - run: docker build -t $IMAGE_NAME .

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Install Minikube
        run: |
          curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
          sudo install minikube-linux-amd64 /usr/local/bin/minikube

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Start Minikube
        run: minikube start --driver=docker

      - name: Use Minikube context
        run: kubectl config use-context minikube

      - name: Set up Docker inside Minikube
        run: |
          eval $(minikube docker-env)

      - name: Build Docker image inside Minikube
        run: |
          docker build -t $IMAGE_NAME .

      - name: Apply Kubernetes manifests
        run: |
          cat <<EOF | tee k8s.yaml
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: scalabit-api
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: scalabit-api
            template:
              metadata:
                labels:
                  app: scalabit-api
              spec:
                containers:
                  - name: scalabit-api
                    image: scalabit-api:latest
                    imagePullPolicy: Never
                    ports:
                      - containerPort: 8080
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: scalabit-api-service
          spec:
            selector:
              app: scalabit-api
            ports:
              - protocol: TCP
                port: 8080
                targetPort: 8080
            type: NodePort
          EOF

          kubectl apply -f k8s.yaml

      - name: Wait for Deployment rollout
        run: kubectl rollout status deployment/scalabit-api --timeout=180s

      - name: Expose Service URL
        run: |
          URL=$(minikube service scalabit-api-service --url)
          echo "Service URL: $URL"
